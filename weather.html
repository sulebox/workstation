<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Choco-Mint Weather</title>
    
    <!-- Tailwind CSS (CDN) -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Tailwind Config for CSS Variables -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        theme: {
                            bg: 'var(--bg-color)',       // Page Background
                            text: 'var(--text-color)',   // Main Text (Brown)
                            accent: 'var(--accent-color)', // Bright Accent (Mint/Yellow/Pink)
                            dark: 'var(--dark-color)',   // Dark areas (Card Top)
                            ring: 'var(--ring-color)',   // Decorative Rings
                            border: 'var(--border-color)' // Borders
                        }
                    },
                    animation: {
                        'float': 'float 3s ease-in-out infinite',
                    },
                    keyframes: {
                        float: {
                            '0%, 100%': { transform: 'translateY(0)' },
                            '50%': { transform: 'translateY(-10px)' },
                        }
                    }
                }
            }
        }
    </script>

    <!-- FontAwesome (Icons) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@400;700;800&display=swap" rel="stylesheet">

    <style>
        /* Default Theme Variables (Choco-Mint) */
        :root {
            --bg-color: #E0F7FA;        /* Pale Mint */
            --text-color: #3E2723;      /* Chocolate */
            --accent-color: #26C6DA;    /* Vibrant Mint */
            --dark-color: #3E2723;      /* Chocolate */
            --ring-color: #B2EBF2;      /* Light Mint Ring */
            --border-color: #3E2723;    /* Brown Border */
        }

        body {
            font-family: 'M PLUS Rounded 1c', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            transition: background-color 0.5s ease, color 0.5s ease;
        }

        /* Smooth transitions for all theme-colored elements */
        .theme-transition {
            transition: all 0.5s ease;
        }
        
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: rgba(0,0,0,0.05); }
        ::-webkit-scrollbar-thumb { background: rgba(0,0,0,0.2); border-radius: 10px; }
    </style>
</head>
<body class="min-h-screen flex justify-center items-center p-4 md:p-8">

    <!-- Mobile Container -->
    <div class="w-full max-w-md min-h-[800px] flex flex-col relative transition-colors duration-500">
        
        <!-- Header -->
        <div class="flex flex-col items-center mb-6 pt-4">
            <!-- Icon Badge -->
            <div class="bg-theme-dark p-3 rounded-full shadow-lg mb-3 ring-4 ring-theme-ring z-10 theme-transition">
                <i class="fa-solid fa-cloud-sun text-theme-accent text-3xl theme-transition"></i>
            </div>
            <h1 class="text-3xl font-extrabold tracking-tight text-theme-text theme-transition">天気予報</h1>
            
            <!-- Theme Switcher Dropdown -->
            <div class="mt-4 relative z-50">
                <button 
                    onclick="toggleThemeMenu()"
                    class="flex items-center gap-2 bg-white border-2 border-theme-border px-4 py-1.5 rounded-full cursor-pointer hover:bg-gray-50 transition-colors shadow-sm"
                >
                    <i class="fa-solid fa-palette text-theme-text"></i>
                    <span id="currentThemeLabel" class="font-bold text-sm text-theme-text">チョコミント</span>
                    <i class="fa-solid fa-chevron-down text-theme-text text-xs"></i>
                </button>

                <!-- Dropdown Menu -->
                <div id="themeMenu" class="hidden absolute top-10 left-1/2 -translate-x-1/2 w-48 bg-white border-2 border-theme-border rounded-xl shadow-xl overflow-hidden animate-fade-in-down">
                    <div class="flex flex-col">
                        <button onclick="setTheme('mint')" class="px-4 py-3 text-left font-bold text-[#3E2723] hover:bg-[#E0F7FA] flex items-center gap-2 transition-colors">
                            <div class="w-3 h-3 rounded-full bg-[#26C6DA]"></div> チョコミント
                        </button>
                        <button onclick="setTheme('banana')" class="px-4 py-3 text-left font-bold text-[#4E342E] hover:bg-[#FFF9C4] flex items-center gap-2 transition-colors">
                            <div class="w-3 h-3 rounded-full bg-[#FDD835]"></div> チョコバナナ
                        </button>
                        <button onclick="setTheme('strawberry')" class="px-4 py-3 text-left font-bold text-[#5D4037] hover:bg-[#FCE4EC] flex items-center gap-2 transition-colors">
                            <div class="w-3 h-3 rounded-full bg-[#F48FB1]"></div> ストロベリーチョコ
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Search Bar -->
        <div class="flex gap-2 mb-6">
            <div class="flex-1 relative">
                <input 
                    type="text" 
                    id="searchInput" 
                    placeholder="都市名を入力 (例: Paris)" 
                    class="w-full bg-white border-2 border-theme-border rounded-2xl h-12 pl-10 pr-4 text-theme-text font-bold shadow-sm focus:outline-none focus:ring-2 focus:ring-theme-accent placeholder-theme-text/50 theme-transition"
                >
                <i class="fa-solid fa-search absolute left-4 top-1/2 -translate-y-1/2 text-theme-text theme-transition"></i>
            </div>
            <button 
                id="searchBtn"
                class="w-12 h-12 bg-theme-dark rounded-2xl flex items-center justify-center text-theme-accent shadow-lg active:scale-95 transition-transform hover:opacity-90 theme-transition"
            >
                <i class="fa-solid fa-arrow-right text-lg"></i>
            </button>
        </div>

        <!-- Error Message -->
        <div id="errorMsg" class="hidden mb-4 bg-white/80 border-2 border-red-400 text-red-800 px-4 py-3 rounded-2xl text-center font-bold text-sm animate-bounce backdrop-blur-sm">
            <i class="fa-solid fa-circle-exclamation mr-2"></i>
            <span id="errorText">都市が見つかりません</span>
        </div>

        <!-- Main Card (Bi-Color) -->
        <div id="mainCard" class="rounded-[2.5rem] overflow-hidden shadow-xl mb-6 relative group theme-transition">
            
            <!-- Top Half: Dark Theme Color -->
            <div class="bg-theme-dark p-8 pb-12 text-white flex flex-col items-center relative z-10 text-center theme-transition">
                <div class="flex items-center gap-2 mb-2 opacity-80">
                    <i class="fa-solid fa-location-dot text-theme-accent theme-transition"></i>
                    <span class="text-xs font-bold tracking-wider uppercase">Current Location</span>
                </div>
                <h2 id="cityName" class="text-3xl font-bold mb-6">---</h2>
                
                <div class="mb-2 text-theme-accent animate-float theme-transition">
                    <i id="weatherIconMain" class="fa-solid fa-cloud text-7xl"></i>
                </div>
            </div>

            <!-- Divider Circle Button -->
            <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 z-20 mt-2">
                <div class="bg-white p-2 rounded-full shadow-md border-4 border-theme-bg theme-transition">
                    <i class="fa-solid fa-arrows-rotate text-theme-dark text-xl theme-transition"></i>
                </div>
            </div>

            <!-- Bottom Half: Accent Theme Color -->
            <div class="bg-theme-accent p-8 pt-12 text-theme-dark flex flex-col items-center relative z-0 theme-transition">
                <div class="flex items-start justify-center leading-none mb-2">
                    <span id="currentTemp" class="text-7xl font-bold">--</span>
                    <span class="text-3xl font-bold mt-2">°C</span>
                </div>
                <p id="weatherDesc" class="font-bold text-lg opacity-90 mb-4">---</p>
                <div class="flex gap-4 opacity-75 font-bold text-sm bg-white/30 px-4 py-1 rounded-full">
                    <span>H: <span id="tempMax">--</span>°</span>
                    <span>L: <span id="tempMin">--</span>°</span>
                </div>
            </div>
        </div>

        <!-- Details Grid -->
        <div class="mb-6">
            <h3 class="text-theme-text font-bold ml-2 mb-3 text-sm uppercase tracking-wider opacity-70 theme-transition">詳細データ</h3>
            <div class="grid grid-cols-3 gap-3">
                
                <!-- Card 1: Active Style -->
                <div class="bg-theme-dark rounded-2xl p-3 flex flex-col items-center justify-center gap-2 shadow-lg text-theme-accent theme-transition">
                    <i class="fa-solid fa-temperature-half text-xl"></i>
                    <span class="text-[10px] font-bold uppercase opacity-80">体感温度</span>
                    <span class="text-lg font-bold text-white"><span id="feelsLike">--</span>°</span>
                </div>
                
                <!-- Card 2: Secondary Style -->
                <div class="bg-white border-2 border-theme-border rounded-2xl p-3 flex flex-col items-center justify-center gap-2 shadow-sm text-theme-text theme-transition">
                    <i class="fa-solid fa-droplet text-xl"></i>
                    <span class="text-[10px] font-bold uppercase opacity-70">湿度</span>
                    <span class="text-lg font-bold"><span id="humidity">--</span>%</span>
                </div>

                <!-- Card 3: Secondary Style -->
                <div class="bg-white border-2 border-theme-border rounded-2xl p-3 flex flex-col items-center justify-center gap-2 shadow-sm text-theme-text theme-transition">
                    <i class="fa-solid fa-wind text-xl"></i>
                    <span class="text-[10px] font-bold uppercase opacity-70">風速</span>
                    <span class="text-lg font-bold"><span id="windSpeed">--</span> <span class="text-xs">m/s</span></span>
                </div>
            </div>
        </div>

        <!-- Weekly Forecast -->
        <div class="flex-1 pb-8">
            <h3 class="text-theme-text font-bold ml-2 mb-3 text-sm uppercase tracking-wider opacity-70 theme-transition">週間予報</h3>
            <div id="forecastList" class="bg-white/50 rounded-[2rem] p-4 backdrop-blur-sm border border-white/60 min-h-[200px]">
                <p class="text-center text-theme-text/50 py-10 font-bold text-sm">Loading forecast...</p>
            </div>
        </div>
        
        <!-- Decorative Background Gradient -->
        <div class="fixed bottom-0 left-0 w-full h-32 bg-gradient-to-t from-theme-accent/20 to-transparent pointer-events-none z-[-1] theme-transition"></div>

    </div>

    <!-- JavaScript Logic -->
    <script>
        // ==========================================
        // CONFIGURATION & STATE
        // ==========================================
        
        // NOTE: API Key logic is now handled by the backend (/api/weather)
        
        const searchInput = document.getElementById('searchInput');
        const searchBtn = document.getElementById('searchBtn');
        const errorMsg = document.getElementById('errorMsg');
        const errorText = document.getElementById('errorText');

        // --- Theme Data ---
        const themes = {
            mint: {
                label: 'チョコミント',
                vars: {
                    '--bg-color': '#E0F7FA',
                    '--text-color': '#3E2723',
                    '--accent-color': '#26C6DA',
                    '--dark-color': '#3E2723',
                    '--ring-color': '#B2EBF2',
                    '--border-color': '#3E2723'
                }
            },
            banana: {
                label: 'チョコバナナ',
                vars: {
                    '--bg-color': '#FFF9C4',
                    '--text-color': '#4E342E',
                    '--accent-color': '#FDD835',
                    '--dark-color': '#4E342E',
                    '--ring-color': '#FFF59D',
                    '--border-color': '#4E342E'
                }
            },
            strawberry: {
                label: 'ストロベリーチョコ',
                vars: {
                    '--bg-color': '#FCE4EC',
                    '--text-color': '#5D4037',
                    '--accent-color': '#F48FB1',
                    '--dark-color': '#5D4037',
                    '--ring-color': '#F8BBD0',
                    '--border-color': '#5D4037'
                }
            }
        };

        // --- Theme Logic ---
        function toggleThemeMenu() {
            const menu = document.getElementById('themeMenu');
            menu.classList.toggle('hidden');
        }

        function setTheme(themeKey) {
            const theme = themes[themeKey];
            const root = document.documentElement;
            for (const [key, value] of Object.entries(theme.vars)) {
                root.style.setProperty(key, value);
            }
            document.getElementById('currentThemeLabel').textContent = theme.label;
            document.getElementById('themeMenu').classList.add('hidden');
        }

        window.addEventListener('click', (e) => {
            const menu = document.getElementById('themeMenu');
            const btn = document.querySelector('button[onclick="toggleThemeMenu()"]');
            if (!btn.contains(e.target) && !menu.contains(e.target)) {
                menu.classList.add('hidden');
            }
        });

        // --- Weather Logic (Updated for Backend) ---

        window.addEventListener('load', () => {
            fetchWeatherData('Tokyo');
        });

        searchBtn.addEventListener('click', () => {
            const city = searchInput.value.trim();
            if (city) fetchWeatherData(city);
        });

        searchInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                const city = searchInput.value.trim();
                if (city) fetchWeatherData(city);
            }
        });

        async function fetchWeatherData(city) {
            hideError();
            try {
                // Call our own Vercel Serverless Function
                // This backend handles the API Key securely
                const res = await fetch(`/api/weather?city=${encodeURIComponent(city)}`);
                
                const data = await res.json();

                if (!res.ok) {
                    throw new Error(data.error || 'API Request Failed');
                }

                // The backend returns combined data: { current: {...}, forecast: {...} }
                updateCurrentUI(data.current);
                updateForecastUI(data.forecast);

            } catch (err) {
                console.error(err);
                showError(err.message === 'city not found' ? '都市が見つかりません。名前を確認してください。' : '通信エラーが発生しました。');
            }
        }

        function updateCurrentUI(data) {
            document.getElementById('cityName').textContent = data.name;
            document.getElementById('currentTemp').textContent = Math.round(data.main.temp);
            document.getElementById('weatherDesc').textContent = data.weather[0].description;
            document.getElementById('tempMax').textContent = Math.round(data.main.temp_max);
            document.getElementById('tempMin').textContent = Math.round(data.main.temp_min);
            document.getElementById('feelsLike').textContent = Math.round(data.main.feels_like);
            document.getElementById('humidity').textContent = data.main.humidity;
            document.getElementById('windSpeed').textContent = data.wind.speed;

            const iconClass = getWeatherIcon(data.weather[0].id);
            const iconEl = document.getElementById('weatherIconMain');
            iconEl.className = `fa-solid ${iconClass} text-7xl`;
        }

        function updateForecastUI(data) {
            const listContainer = document.getElementById('forecastList');
            listContainer.innerHTML = ''; 
            
            const dailyData = {};
            
            data.list.forEach(item => {
                const date = new Date(item.dt * 1000);
                const dateStr = date.toLocaleDateString('ja-JP', { weekday: 'short', day: 'numeric' });
                
                if (!dailyData[dateStr]) {
                    dailyData[dateStr] = item;
                } else {
                    const savedDate = new Date(dailyData[dateStr].dt * 1000);
                    if (Math.abs(date.getHours() - 12) < Math.abs(savedDate.getHours() - 12)) {
                        dailyData[dateStr] = item;
                    }
                }
            });

            const forecastDays = Object.keys(dailyData).slice(0, 5);

            forecastDays.forEach(dateStr => {
                const dayData = dailyData[dateStr];
                const temp = Math.round(dayData.main.temp);
                const iconClass = getWeatherIcon(dayData.weather[0].id);
                const desc = dayData.weather[0].description;

                const html = `
                    <div class="flex items-center justify-between py-3 px-2 border-b border-theme-border/10 last:border-0 hover:bg-white/60 rounded-xl transition-colors cursor-pointer group theme-transition">
                        <div class="flex items-center gap-4 w-1/3">
                            <span class="font-bold text-theme-text theme-transition">${dateStr}</span>
                        </div>
                        
                        <div class="flex items-center gap-2 justify-center w-1/3 text-theme-text group-hover:scale-110 transition-transform theme-transition">
                            <i class="fa-solid ${iconClass} text-xl"></i>
                        </div>

                        <div class="flex items-center justify-end w-1/3 gap-1">
                            <span class="font-bold text-lg text-theme-text theme-transition">${temp}°</span>
                            <span class="text-xs text-theme-text/60 hidden sm:inline-block theme-transition">${desc}</span>
                        </div>
                    </div>
                `;
                listContainer.insertAdjacentHTML('beforeend', html);
            });
        }

        function getWeatherIcon(id) {
            if (id >= 200 && id < 300) return 'fa-bolt';
            if (id >= 300 && id < 400) return 'fa-cloud-rain';
            if (id >= 500 && id < 600) return 'fa-cloud-showers-heavy';
            if (id >= 600 && id < 700) return 'fa-snowflake';
            if (id >= 700 && id < 800) return 'fa-smog';
            if (id === 800) return 'fa-sun';
            return 'fa-cloud';
        }

        function showError(msg) {
            errorText.textContent = msg;
            errorMsg.classList.remove('hidden');
        }

        function hideError() {
            errorMsg.classList.add('hidden');
        }

    </script>
</body>
</html>